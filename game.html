<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Warcaby - Gra</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      table {
        border-collapse: collapse;
        margin: 20px 0;
      }
      td,
      th {
        border: 1px solid #333;
        width: 40px;
        height: 40px;
        text-align: center;
        vertical-align: middle;
        font-size: 18px;
      }
      .board-cell {
        cursor: pointer;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .section {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div id="userMenu" class="section">
      <button id="logoutBtn">Wyloguj się</button>
    </div>

    <h1>Warcaby</h1>
    <div>
      <button id="createGameBtn">Nowa gra</button>
    </div>
    <div class="section">
      <label for="gameIdInput">Wybierz grę (ID): </label>
      <input type="number" id="gameIdInput" min="1" />
      <button id="loadGameBtn">Wczytaj grę</button>
    </div>
    <div id="gameInfo" class="section">
      <p>Numer gry: <span id="gameId">?</span></p>
      <p>Aktualny ruch gracza: <span id="currentPlayer">?</span></p>
      <p>Twórca gry (Player1): <span id="player1">?</span></p>
      <p>Zaproszony gracz (Player2): <span id="player2">?</span></p>
      <p id="winnerMessage" style="color: red"></p>
    </div>
    <div class="section">
      <table id="boardTable"></table>
    </div>
    <div class="section">
      <h3>Wykonaj ruch</h3>
      <form id="moveForm">
        <label>Od (x, y):</label>
        <input type="number" id="fromX" min="0" max="7" required />
        <input type="number" id="fromY" min="0" max="7" required />
        <br />
        <label>Do (x, y):</label>
        <input type="number" id="toX" min="0" max="7" required />
        <input type="number" id="toY" min="0" max="7" required />
        <br />
        <button type="submit">Wykonaj ruch</button>
      </form>
    </div>

    <div class="section">
      <h3>Zaproś użytkownika do gry</h3>
      <form id="inviteForm">
        <label>Identyfikator zapraszanego użytkownika:</label>
        <input type="number" id="inviteeID" min="1" required />
        <button type="submit">Wyślij zaproszenie</button>
      </form>
    </div>

    <script>
      // $.ajaxSetup({
      //   headers: {
      //     "X-User-ID": "1",
      //   },
      // });
      $("#logoutBtn").click(function () {
        localStorage.removeItem("userID");
        $.ajaxSetup({
          headers: {},
        });
        window.location.href = "/login";
      });

      $(document).ready(function () {
        const userID = localStorage.getItem("userID");
        if (!userID) {
          window.location.href = "/login";
        } else {
          $.ajaxSetup({
            headers: { "X-User-ID": userID },
          });
          fetchGame();
        }
      });

      let gameId = 1;

      function pieceToSymbol(piece) {
        switch (piece) {
          case 1:
            return "C";
          case 2:
            return "B";
          default:
            return "";
        }
      }

      function renderBoard(game) {
        $("#gameId").text(game.ID);
        $("#currentPlayer").text(game.CurrentPlayer === 1 ? "Czarne" : "Białe");
        $("#player1").text(game.Player1Nick ? game.Player1Nick : "?");
        $("#player2").text(game.Player2Nick ? game.Player2Nick : "Brak");
        if (game.Winner && game.Winner !== 0) {
          $("#winnerMessage").text(
            "Koniec gry! Zwyciężyły " +
              (game.Winner === 1 ? "Czarne" : "Białe"),
          );
        } else {
          $("#winnerMessage").text("");
        }
        let board = game.Board;
        let tableHtml = "<tr><th></th>";
        for (let col = 0; col < board[0].length; col++) {
          tableHtml += "<th>" + col + "</th>";
        }
        tableHtml += "</tr>";

        for (let i = 0; i < board.length; i++) {
          tableHtml += "<tr>";
          tableHtml += "<th>" + i + "</th>";
          for (let j = 0; j < board[i].length; j++) {
            let symbol = pieceToSymbol(board[i][j]);
            tableHtml += "<td class='board-cell'>" + symbol + "</td>";
          }
          tableHtml += "</tr>";
        }
        $("#boardTable").html(tableHtml);
      }

      function fetchGame() {
        $.ajax({
          url: "/games/" + gameId,
          method: "GET",
          success: function (data) {
            renderBoard(data);
          },
          error: function (err) {
            alert("Błąd pobierania gry: " + err.responseText);
          },
        });
      }

      function createGame() {
        $.ajax({
          url: "/games/new",
          method: "POST",
          success: function (data) {
            gameId = data.ID;
            renderBoard(data);
          },
          error: function (err) {
            alert("Błąd tworzenia gry: " + err.responseText);
          },
        });
      }

      $(document).ready(function () {
        fetchGame();

        $("#createGameBtn").click(function () {
          createGame();
        });

        $("#loadGameBtn").click(function () {
          let id = parseInt($("#gameIdInput").val());
          if (id > 0) {
            gameId = id;
            fetchGame();
          } else {
            alert("Podaj prawidłowe ID gry.");
          }
        });

        $("#moveForm").submit(function (e) {
          e.preventDefault();
          let fromX = parseInt($("#fromX").val());
          let fromY = parseInt($("#fromY").val());
          let toX = parseInt($("#toX").val());
          let toY = parseInt($("#toY").val());
          $.ajax({
            url: "/games/" + gameId + "/move",
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify({
              fromX: fromX,
              fromY: fromY,
              toX: toX,
              toY: toY,
            }),
            success: function (data) {
              renderBoard(data);
            },
            error: function (err) {
              alert("Błąd wykonania ruchu: " + err.responseText);
            },
          });
        });

        $("#inviteForm").submit(function (e) {
          e.preventDefault();
          let inviteeID = parseInt($("#inviteeID").val());
          $.ajax({
            url: "/games/" + gameId + "/invite",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ inviteeID: inviteeID }),
            success: function (data) {
              alert("Użytkownik zaproszony!");
              renderBoard(data);
            },
            error: function (err) {
              alert("Błąd zapraszania: " + err.responseText);
            },
          });
        });
      });
    </script>
  </body>
</html>
